<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Prueba - Cierre RTO</title>
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .test-container {
            max-width: 1200px;
            margin: 0 auto;
        }
        .test-header {
            background: white;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .test-section {
            background: white;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .auth-section {
            background: #e3f2fd;
            border: 1px solid #2196f3;
        }
        .btn {
            padding: 10px 20px;
            margin: 5px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
        }
        .btn-primary {
            background: #2196f3;
            color: white;
        }
        .btn-success {
            background: #4caf50;
            color: white;
        }
        .btn-warning {
            background: #ff9800;
            color: white;
        }
        .input-group {
            margin: 10px 0;
        }
        .input-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }
        .input-group input {
            width: 200px;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        .status {
            padding: 10px;
            margin: 10px 0;
            border-radius: 4px;
        }
        .status-success {
            background: #e8f5e8;
            color: #2e7d32;
            border: 1px solid #c8e6c9;
        }
        .status-error {
            background: #ffebee;
            color: #d32f2f;
            border: 1px solid #ffcdd2;
        }
        .status-info {
            background: #e3f2fd;
            color: #1976d2;
            border: 1px solid #bbdefb;
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        // Simulaci√≥n del componente CierreRTO para pruebas
        const CierreRTO = ({ 
          ptsId, 
          responsableLegajo = 'LEG-CIERRE-001', 
          onSuccess, 
          onCancel 
        }) => {
          const [observaciones, setObservaciones] = React.useState('');
          const [loading, setLoading] = React.useState(false);
          const [error, setError] = React.useState(null);
          const [success, setSuccess] = React.useState(false);

          const handleCierreRTO = async () => {
            if (!ptsId) {
              setError('ID del PTS es requerido');
              alert('Error: ID del PTS es requerido');
              return;
            }

            const jwtToken = localStorage.getItem('jwtToken');
            if (!jwtToken) {
              setError('No se encontr√≥ token de autenticaci√≥n');
              alert('Error: Debe iniciar sesi√≥n para cerrar un PTS');
              return;
            }

            const confirmacion = window.confirm(
              `¬øEst√° seguro que desea cerrar el PTS ${ptsId}?\n\n` +
              'Esta acci√≥n no se puede deshacer y marcar√° el PTS como "Retorno a Operaciones".'
            );
            
            if (!confirmacion) {
              return;
            }

            const cerrarPtsRequest = {
              ptsId: ptsId,
              rtoResponsableCierreLegajo: responsableLegajo,
              rtoObservaciones: observaciones.trim() || null
            };

            setLoading(true);
            setError(null);
            setSuccess(false);

            try {
              console.log('Enviando petici√≥n de cierre RTO:', cerrarPtsRequest);

              const response = await fetch('/api/pts/cerrar', {
                method: 'PUT',
                headers: {
                  'Content-Type': 'application/json',
                  'Authorization': `Bearer ${jwtToken}`
                },
                body: JSON.stringify(cerrarPtsRequest)
              });

              const responseData = await response.json();

              if (response.ok) {
                setSuccess(true);
                setError(null);
                
                const mensaje = `‚úÖ PTS ${ptsId} cerrado exitosamente\n\n` +
                               `Estado: ${responseData.rtoEstado}\n` +
                               `Responsable: ${responseData.rtoResponsableCierreLegajo}\n` +
                               `Fecha de cierre: ${new Date(responseData.rtoFechaHoraCierre).toLocaleString()}`;
                
                alert(mensaje);
                setObservaciones('');
                
                if (onSuccess) {
                  onSuccess(responseData);
                }
                
              } else {
                let errorMessage = 'Error desconocido al cerrar el PTS';
                
                switch (response.status) {
                  case 400:
                    errorMessage = responseData.error || 'Datos de entrada inv√°lidos';
                    break;
                  case 403:
                    errorMessage = 'No tiene permisos para cerrar este PTS';
                    break;
                  case 404:
                    errorMessage = `PTS ${ptsId} no encontrado`;
                    break;
                  case 409:
                    errorMessage = responseData.error || 'El PTS ya est√° cerrado o no puede cerrarse';
                    break;
                  case 500:
                    errorMessage = 'Error interno del servidor';
                    break;
                  default:
                    errorMessage = `Error ${response.status}: ${responseData.error || 'Error desconocido'}`;
                }
                
                setError(errorMessage);
                alert(`‚ùå Error: ${errorMessage}`);
              }

            } catch (networkError) {
              const errorMessage = 'Error de conexi√≥n con el servidor';
              setError(errorMessage);
              alert(`‚ùå ${errorMessage}: ${networkError.message}`);
              console.error('Error de red:', networkError);
            } finally {
              setLoading(false);
            }
          };

          const handleCancel = () => {
            if (onCancel) {
              onCancel();
            }
          };

          return (
            <div style={{ 
              background: 'white', 
              borderRadius: '8px', 
              boxShadow: '0 2px 10px rgba(0, 0, 0, 0.1)', 
              padding: '24px', 
              maxWidth: '600px', 
              margin: '0 auto' 
            }}>
              <h3 style={{ color: '#d32f2f', marginBottom: '20px', textAlign: 'center' }}>
                üîí Cerrar PTS - Retorno a Operaciones (RTO)
              </h3>
              
              <div style={{ background: '#f5f5f5', padding: '12px', borderRadius: '4px', marginBottom: '20px' }}>
                <p><strong>PTS ID:</strong> {ptsId}</p>
                <p><strong>Responsable de Cierre:</strong> {responsableLegajo}</p>
              </div>

              <div style={{ marginBottom: '20px' }}>
                <label style={{ display: 'block', marginBottom: '8px', color: '#333', fontWeight: 'bold' }}>
                  Observaciones del Cierre (Opcional):
                </label>
                <textarea
                  value={observaciones}
                  onChange={(e) => setObservaciones(e.target.value)}
                  placeholder="Ingrese observaciones finales sobre el cierre del PTS..."
                  rows={4}
                  cols={50}
                  maxLength={500}
                  disabled={loading}
                  style={{
                    width: '100%',
                    padding: '10px',
                    border: '2px solid #ddd',
                    borderRadius: '4px',
                    fontFamily: 'Arial, sans-serif',
                    fontSize: '14px',
                    resize: 'vertical',
                    boxSizing: 'border-box'
                  }}
                />
                <small style={{ display: 'block', textAlign: 'right', color: '#666', marginTop: '4px' }}>
                  {observaciones.length}/500 caracteres
                </small>
              </div>

              {error && (
                <div style={{
                  background: '#ffebee',
                  color: '#d32f2f',
                  padding: '12px',
                  borderRadius: '4px',
                  border: '1px solid #ffcdd2',
                  marginBottom: '16px'
                }}>
                  ‚ùå {error}
                </div>
              )}

              {success && (
                <div style={{
                  background: '#e8f5e8',
                  color: '#2e7d32',
                  padding: '12px',
                  borderRadius: '4px',
                  border: '1px solid #c8e6c9',
                  marginBottom: '16px'
                }}>
                  ‚úÖ PTS cerrado exitosamente
                </div>
              )}

              <div style={{ display: 'flex', gap: '12px', justifyContent: 'center', marginBottom: '20px' }}>
                <button
                  onClick={handleCierreRTO}
                  disabled={loading || !ptsId}
                  style={{
                    background: loading ? '#ff9800' : '#d32f2f',
                    color: 'white',
                    border: 'none',
                    padding: '12px 24px',
                    borderRadius: '4px',
                    cursor: loading || !ptsId ? 'not-allowed' : 'pointer',
                    fontSize: '16px',
                    fontWeight: 'bold'
                  }}
                >
                  {loading ? 'üîÑ Cerrando PTS...' : 'üîí Cerrar PTS (RTO)'}
                </button>

                {onCancel && (
                  <button
                    onClick={handleCancel}
                    disabled={loading}
                    style={{
                      background: '#666',
                      color: 'white',
                      border: 'none',
                      padding: '12px 24px',
                      borderRadius: '4px',
                      cursor: loading ? 'not-allowed' : 'pointer',
                      fontSize: '16px'
                    }}
                  >
                    Cancelar
                  </button>
                )}
              </div>

              <div style={{
                background: '#fff3e0',
                padding: '12px',
                borderRadius: '4px',
                border: '1px solid #ffcc02',
                textAlign: 'center'
              }}>
                <small style={{ color: '#e65100' }}>
                  ‚ö†Ô∏è <strong>Importante:</strong> Una vez cerrado, el PTS no podr√° ser modificado.
                  Aseg√∫rese de que todas las tareas est√©n completadas antes del cierre.
                </small>
              </div>
            </div>
          );
        };

        // Componente principal de pruebas
        const TestApp = () => {
          const [ptsId, setPtsId] = React.useState('PTS-001');
          const [responsableLegajo, setResponsableLegajo] = React.useState('LEG-CIERRE-001');
          const [isAuthenticated, setIsAuthenticated] = React.useState(false);
          const [authStatus, setAuthStatus] = React.useState('');

          React.useEffect(() => {
            // Verificar si hay token al cargar
            const token = localStorage.getItem('jwtToken');
            if (token) {
              setIsAuthenticated(true);
              setAuthStatus('Usuario autenticado');
            } else {
              setAuthStatus('No hay token de autenticaci√≥n');
            }
          }, []);

          const simularLogin = () => {
            // Simular token JWT para pruebas
            const fakeToken = 'eyJ0eXAiOiJKV1QiLCJhbGciOiJIUzI1NiJ9.eyJzdWIiOiJ0ZXN0dXNlciIsImV4cCI6MTY5OTk5OTk5OX0.fake-signature-for-testing';
            localStorage.setItem('jwtToken', fakeToken);
            setIsAuthenticated(true);
            setAuthStatus('‚úÖ Token JWT simulado guardado en localStorage');
            console.log('Token guardado:', fakeToken);
          };

          const cerrarSesion = () => {
            localStorage.removeItem('jwtToken');
            setIsAuthenticated(false);
            setAuthStatus('‚ùå Token eliminado del localStorage');
          };

          const verificarToken = () => {
            const token = localStorage.getItem('jwtToken');
            if (token) {
              setAuthStatus(`‚úÖ Token presente: ${token.substring(0, 50)}...`);
            } else {
              setAuthStatus('‚ùå No hay token en localStorage');
            }
          };

          const onSuccessHandler = (ptsActualizado) => {
            console.log('‚úÖ Callback onSuccess ejecutado:', ptsActualizado);
            setAuthStatus(`‚úÖ PTS cerrado exitosamente: ${ptsActualizado.id} - Estado: ${ptsActualizado.rtoEstado}`);
          };

          const onCancelHandler = () => {
            console.log('‚ùå Callback onCancel ejecutado');
            setAuthStatus('‚ùå Operaci√≥n de cierre cancelada por el usuario');
          };

          return (
            <div className="test-container">
              <div className="test-header">
                <h1>üß™ Prueba del Componente CierreRTO</h1>
                <p>Esta p√°gina permite probar la funcionalidad de "Retorno a Operaciones" (RTO) del sistema PTS.</p>
              </div>

              <div className="test-section auth-section">
                <h3>üîê Autenticaci√≥n (Simulada)</h3>
                <div className="input-group">
                  <button className="btn btn-primary" onClick={simularLogin}>
                    üîë Simular Login (Generar JWT)
                  </button>
                  <button className="btn btn-warning" onClick={verificarToken}>
                    üîç Verificar Token
                  </button>
                  <button className="btn btn-warning" onClick={cerrarSesion}>
                    üö™ Cerrar Sesi√≥n
                  </button>
                </div>
                <div className={`status ${isAuthenticated ? 'status-success' : 'status-error'}`}>
                  {authStatus}
                </div>
              </div>

              <div className="test-section">
                <h3>‚öôÔ∏è Configuraci√≥n de Prueba</h3>
                <div className="input-group">
                  <label>PTS ID:</label>
                  <input 
                    type="text" 
                    value={ptsId} 
                    onChange={(e) => setPtsId(e.target.value)}
                    placeholder="Ej: PTS-001"
                  />
                </div>
                <div className="input-group">
                  <label>Responsable Legajo:</label>
                  <input 
                    type="text" 
                    value={responsableLegajo} 
                    onChange={(e) => setResponsableLegajo(e.target.value)}
                    placeholder="Ej: LEG-CIERRE-001"
                  />
                </div>
                <div className="status status-info">
                  üí° <strong>Tip:</strong> Para probar en modo test, use PTS-001 o PTS-002. 
                  Para probar errores, use IDs no v√°lidos como PTS-999.
                </div>
              </div>

              <div className="test-section">
                <h3>üîí Componente CierreRTO</h3>
                <CierreRTO 
                  ptsId={ptsId}
                  responsableLegajo={responsableLegajo}
                  onSuccess={onSuccessHandler}
                  onCancel={onCancelHandler}
                />
              </div>

              <div className="test-section">
                <h3>üìã Instrucciones de Prueba</h3>
                <ol>
                  <li><strong>Autenticarse:</strong> Click en "Simular Login" para generar un token JWT</li>
                  <li><strong>Configurar PTS:</strong> Ingrese un PTS ID v√°lido (ej: PTS-001 para modo test)</li>
                  <li><strong>Probar Cierre:</strong> Complete observaciones y click en "Cerrar PTS (RTO)"</li>
                  <li><strong>Verificar Respuesta:</strong> Observe los mensajes de √©xito/error</li>
                </ol>
                
                <h4>üéØ Escenarios de Prueba:</h4>
                <ul>
                  <li><strong>√âxito:</strong> Token v√°lido + PTS-001/PTS-002 (modo test)</li>
                  <li><strong>Error 404:</strong> Token v√°lido + PTS-999 (no existe)</li>
                  <li><strong>Error 403:</strong> Sin token JWT</li>
                  <li><strong>Error 409:</strong> Intentar cerrar el mismo PTS dos veces</li>
                </ul>
              </div>
            </div>
          );
        };

        // Renderizar la aplicaci√≥n
        ReactDOM.render(<TestApp />, document.getElementById('root'));
    </script>
</body>
</html>